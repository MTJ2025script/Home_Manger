<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Booking</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <style>
        .booking-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-width: 90%;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 30px;
            z-index: 10000;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .booking-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 20px var(--accent-color);
            margin-bottom: 10px;
        }

        .booking-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .booking-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select {
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .booking-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .booking-btn {
            flex: 1;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .booking-btn.primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .booking-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .booking-btn.primary:hover {
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.5);
        }

        .booking-info {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .code-display {
            text-align: center;
            padding: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--success-color);
            border-radius: 15px;
            margin: 20px 0;
        }

        .code-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .code-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--success-color);
            letter-spacing: 8px;
            text-shadow: 0 0 20px var(--success-color);
        }
    </style>
</head>
<body>
    <div class="booking-container" id="bookingContainer">
        <div class="booking-header">
            <h1 class="booking-title">ðŸ“‹ Buchung</h1>
            <p class="booking-subtitle">Immobilie buchen</p>
        </div>

        <div class="booking-info" id="bookingInfo">
            <!-- Property info will be dynamically added here -->
        </div>

        <div class="booking-form" id="bookingForm">
            <div class="form-group">
                <label class="form-label">Buchungsart</label>
                <select class="form-select" id="bookingType">
                    <option value="viewing">Besichtigung (30 Min, Kostenlos)</option>
                    <option value="rental">Kurzzeitmiete (1-7 Tage)</option>
                    <option value="purchase">Kaufen</option>
                </select>
            </div>

            <div class="form-group" id="durationGroup" style="display: none;">
                <label class="form-label">Mietdauer (Tage)</label>
                <input type="number" class="form-input" id="rentalDays" min="1" max="7" value="1">
            </div>

            <div class="form-group" id="paymentGroup" style="display: none;">
                <label class="form-label">Zahlungsmethode</label>
                <select class="form-select" id="paymentMethod">
                    <option value="cash">Bargeld</option>
                    <option value="bank">Bank</option>
                    <option value="mortgage">Hypothek (20% Anzahlung)</option>
                </select>
            </div>
        </div>

        <div class="code-display" id="codeDisplay" style="display: none;">
            <div class="code-label">Ihr Zugangscode:</div>
            <div class="code-value" id="accessCode">----</div>
        </div>

        <div class="booking-actions">
            <button class="booking-btn" id="bookingCancel">Abbrechen</button>
            <button class="booking-btn primary" id="bookingConfirm">BestÃ¤tigen</button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const bookingContainer = document.getElementById('bookingContainer');
        const bookingInfo = document.getElementById('bookingInfo');
        const bookingForm = document.getElementById('bookingForm');
        const bookingType = document.getElementById('bookingType');
        const durationGroup = document.getElementById('durationGroup');
        const paymentGroup = document.getElementById('paymentGroup');
        const codeDisplay = document.getElementById('codeDisplay');
        const bookingConfirm = document.getElementById('bookingConfirm');
        const bookingCancel = document.getElementById('bookingCancel');

        let currentProperty = null;

        // Booking type change
        bookingType.addEventListener('change', () => {
            const type = bookingType.value;
            durationGroup.style.display = type === 'rental' ? 'flex' : 'none';
            paymentGroup.style.display = type === 'purchase' ? 'flex' : 'none';
        });

        // Cancel booking
        bookingCancel.addEventListener('click', () => {
            bookingContainer.style.display = 'none';
            sendNUIMessage('closeBooking');
        });

        // Confirm booking
        bookingConfirm.addEventListener('click', () => {
            const type = bookingType.value;
            const data = {
                propertyId: currentProperty.id,
                type: type
            };

            if (type === 'rental') {
                data.days = parseInt(document.getElementById('rentalDays').value);
            } else if (type === 'purchase') {
                data.paymentMethod = document.getElementById('paymentMethod').value;
            }

            sendNUIMessage('confirmBooking', data);
        });

        // ESC key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && bookingContainer.style.display === 'block') {
                bookingCancel.click();
            }
        });

        // Listen for NUI messages
        window.addEventListener('message', (event) => {
            const data = event.data;

            if (data.action === 'openBooking') {
                openBooking(data.property);
            } else if (data.action === 'closeBooking') {
                bookingContainer.style.display = 'none';
            } else if (data.action === 'showAccessCode') {
                showAccessCode(data.code);
            }
        });

        function openBooking(property) {
            currentProperty = property;
            
            // Display property info
            bookingInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Immobilie:</span>
                    <span class="info-value">${property.name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Typ:</span>
                    <span class="info-value">${property.type}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Preis:</span>
                    <span class="info-value">$${formatNumber(property.price)}</span>
                </div>
            `;

            // Reset form
            bookingType.value = 'viewing';
            durationGroup.style.display = 'none';
            paymentGroup.style.display = 'none';
            codeDisplay.style.display = 'none';
            bookingForm.style.display = 'flex';
            bookingConfirm.style.display = 'block';

            bookingContainer.style.display = 'block';
        }

        function showAccessCode(code) {
            bookingForm.style.display = 'none';
            bookingConfirm.style.display = 'none';
            codeDisplay.style.display = 'block';
            document.getElementById('accessCode').textContent = code;
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function sendNUIMessage(action, data = {}) {
            fetch(`https://${GetParentResourceName()}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }

        function GetParentResourceName() {
            return window.location.hostname === '' ? 'Home_Manger' : window.location.hostname;
        }
    </script>
</body>
</html>
